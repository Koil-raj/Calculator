name: Sonarqube integration and Build and Push Docker Image to ACR

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  sonarqube-scan:
    name: SonarQube Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # recommended for accurate analysis & PR decoration

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        # If you prefer to override properties inline instead of using sonar-project.properties:
        # with:
        #   args: >
        #     -Dsonar.projectKey=simple-flask-app
        #     -Dsonar.sources=.
        #     -Dsonar.python.version=3.11

      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  build-and-push:
    name: Build & Push to ACR
    runs-on: ubuntu-latest
    needs: sonarqube-scan

    outputs:
      image_sha_tag: ${{ steps.meta.outputs.image_sha_tag }}
      image_latest_tag: ${{ steps.meta.outputs.image_latest_tag }}
      image_digest: ${{ steps.meta.outputs.image_digest }}
      image_ref: ${{ steps.meta.outputs.image_ref }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Define image coordinates
        id: meta
        run: |
          IMAGE_REPO="${{ secrets.ACR_LOGIN_SERVER }}/simple-flask-app"
          IMAGE_SHA_TAG="$IMAGE_REPO:${{ github.sha }}"
          IMAGE_LATEST_TAG="$IMAGE_REPO:latest"
          echo "image_repo=$IMAGE_REPO" >> $GITHUB_OUTPUT
          echo "image_sha_tag=$IMAGE_SHA_TAG" >> $GITHUB_OUTPUT
          echo "image_latest_tag=$IMAGE_LATEST_TAG" >> $GITHUB_OUTPUT
          # Pre-populate an empty digest; we'll set it after push
          echo "image_digest=" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ steps.meta.outputs.image_sha_tag }} \
            -t ${{ steps.meta.outputs.image_latest_tag }} \
            .

      - name: Push image (sha tag) and capture digest
        id: push_sha
        run: |
          set -e
          # Capture push output to a file
          docker push "${{ steps.meta.outputs.image_sha_tag }}" | tee push_sha.out
          # Extract digest line
          DIGEST=$(grep -Eo 'digest: sha256:[0-9a-f]+' push_sha.out | awk '{print $2}' | tail -n1)
          echo "Digest from push: $DIGEST"
          echo "image_digest=$DIGEST" >> $GITHUB_OUTPUT
          # Compose canonical image ref with digest
          echo "image_ref=${{ steps.meta.outputs.image_repo }}@${DIGEST}" >> $GITHUB_OUTPUT

      - name: Push image (latest)
        run: |
          docker push "${{ steps.meta.outputs.image_latest_tag }}"

      - name: Publish Job Summary
        if: always()
        run: |
          {
            echo "## Image Published to ACR"
            echo ""
            echo "- **Repository:** `${{ steps.meta.outputs.image_repo }}`"
            echo "- **Tag (commit):** `${{ steps.meta.outputs.image_sha_tag }}`"
            echo "- **Tag (latest):** `${{ steps.meta.outputs.image_latest_tag }}`"
            echo "- **Digest:** `${{ steps.push_sha.outputs.image_digest }}`"
            echo "- **Canonical Ref:** `${{ steps.meta.outputs.image_repo }}@${{ steps.push_sha.outputs.image_digest }}`"
          } >> $GITHUB_STEP_SUMMARY
